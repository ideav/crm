<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test: ddls with fieldHooks extraParams</title>
    <style>
        body { font-family: system-ui, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .test-case { border: 1px solid #ccc; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .pass { background-color: #d4edda; border-color: #28a745; }
        .fail { background-color: #f8d7da; border-color: #dc3545; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 3px; overflow-x: auto; }
        h2 { margin-top: 0; }
    </style>
</head>
<body>
    <h1>Test: ddls URLs with fieldHooks extraParams</h1>
    <p>This test verifies that extraParams from fieldHooks are correctly applied to ddls override URLs.</p>

    <div id="results"></div>

    <script>
        // Test helper to simulate URL modification logic
        function applyExtraParamsToUrl(overrideUrl, extraParams, baseOrigin) {
            if (extraParams && Object.keys(extraParams).length > 0) {
                const url = new URL(overrideUrl, baseOrigin);
                for (const [key, value] of Object.entries(extraParams)) {
                    url.searchParams.set(key, value);
                }
                return url.toString();
            }
            return overrideUrl;
        }

        const tests = [
            {
                name: 'Absolute URL with extraParams',
                input: {
                    url: 'https://api.example.com/report/5230?JSON_KV',
                    extraParams: { FR_partners: '!%' },
                    origin: 'https://localhost'
                },
                expected: 'https://api.example.com/report/5230?JSON_KV=&FR_partners=%21%25'
            },
            {
                name: 'Relative URL resolved against origin with extraParams',
                input: {
                    url: 'https://example.com/api/report/5230?JSON_KV',
                    extraParams: { FR_partners: '%', other: 'value' },
                    origin: 'https://example.com'
                },
                expected: 'https://example.com/api/report/5230?JSON_KV=&FR_partners=%25&other=value'
            },
            {
                name: 'URL with existing params - extraParams should add/override',
                input: {
                    url: 'https://api.example.com/report/5230?JSON_KV&existing=1',
                    extraParams: { FR_partners: '%' },
                    origin: 'https://localhost'
                },
                expected: 'https://api.example.com/report/5230?JSON_KV=&existing=1&FR_partners=%25'
            },
            {
                name: 'Empty extraParams should not modify URL',
                input: {
                    url: 'https://api.example.com/report/5230?JSON_KV',
                    extraParams: {},
                    origin: 'https://localhost'
                },
                expected: 'https://api.example.com/report/5230?JSON_KV'
            },
            {
                name: 'URL without query params - extraParams should add them',
                input: {
                    url: 'https://api.example.com/report/5230',
                    extraParams: { FR_partners: '!%' },
                    origin: 'https://localhost'
                },
                expected: 'https://api.example.com/report/5230?FR_partners=%21%25'
            }
        ];

        const resultsDiv = document.getElementById('results');
        let passCount = 0;
        let failCount = 0;

        tests.forEach(test => {
            const result = applyExtraParamsToUrl(test.input.url, test.input.extraParams, test.input.origin);
            const passed = result === test.expected;

            if (passed) passCount++;
            else failCount++;

            const div = document.createElement('div');
            div.className = `test-case ${passed ? 'pass' : 'fail'}`;
            div.innerHTML = `
                <h2>${passed ? '✅' : '❌'} ${test.name}</h2>
                <p><strong>Input URL:</strong> <code>${test.input.url}</code></p>
                <p><strong>Extra Params:</strong> <code>${JSON.stringify(test.input.extraParams)}</code></p>
                <p><strong>Expected:</strong> <code>${test.expected}</code></p>
                <p><strong>Got:</strong> <code>${result}</code></p>
            `;
            resultsDiv.appendChild(div);
        });

        // Summary
        const summary = document.createElement('div');
        summary.style.padding = '15px';
        summary.style.marginTop = '20px';
        summary.style.backgroundColor = failCount === 0 ? '#d4edda' : '#f8d7da';
        summary.style.borderRadius = '5px';
        summary.innerHTML = `<strong>Summary:</strong> ${passCount} passed, ${failCount} failed`;
        resultsDiv.insertBefore(summary, resultsDiv.firstChild);
    </script>
</body>
</html>
