<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Object Format URL Construction</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #333;
        }
        .test-case {
            border-left: 4px solid #007bff;
            padding: 10px;
            margin: 10px 0;
            background-color: #f8f9fa;
        }
        .pass {
            border-left-color: #28a745;
        }
        .fail {
            border-left-color: #dc3545;
        }
        .code {
            background-color: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background-color: #fff;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Test Object Format URL Construction</h1>
    <p>This test validates that the URL construction for object format data requests follows the parametrized format specified in issue #296.</p>

    <div class="test-section">
        <h2>Test Case 1: URL Construction</h2>
        <div id="test1-result" class="test-case">Running...</div>
    </div>

    <div class="test-section">
        <h2>Test Case 2: URL Format Validation</h2>
        <div id="test2-result" class="test-case">Running...</div>
    </div>

    <div class="test-section">
        <h2>Test Case 3: Metadata ID Usage</h2>
        <div id="test3-result" class="test-case">Running...</div>
    </div>

    <script>
        // Mock window.db for testing
        window.db = 'testdb';

        // Mock metadata
        const mockMetadata = {
            id: '3596',
            type: '8',
            val: 'Задача',
            reqs: []
        };

        // Test Case 1: URL Construction
        function test1_urlConstruction() {
            const host = window.location.hostname;
            const db = window.db || '';
            const tableId = mockMetadata.id;
            const dataUrl = `https://${host}/${db}/object/${tableId}/?JSON_DATA`;

            const resultDiv = document.getElementById('test1-result');

            const expectedPattern = /^https:\/\/.+\/.+\/object\/\d+\/\?JSON_DATA$/;
            const isValid = expectedPattern.test(dataUrl);

            resultDiv.className = 'test-case ' + (isValid ? 'pass' : 'fail');
            resultDiv.innerHTML = `
                <strong>${isValid ? '✓ PASS' : '✗ FAIL'}</strong>: URL Construction<br>
                <div class="result">
                    <strong>Generated URL:</strong> <span class="code">${dataUrl}</span><br>
                    <strong>Expected Pattern:</strong> <span class="code">https://{host}/{db}/object/{id}/?JSON_DATA</span><br>
                    <strong>Host:</strong> <span class="code">${host}</span><br>
                    <strong>Database:</strong> <span class="code">${db}</span><br>
                    <strong>Table ID:</strong> <span class="code">${tableId}</span>
                </div>
            `;

            return isValid;
        }

        // Test Case 2: URL Format Validation
        function test2_urlFormatValidation() {
            const host = window.location.hostname;
            const db = window.db || '';
            const tableId = mockMetadata.id;
            const dataUrl = `https://${host}/${db}/object/${tableId}/?JSON_DATA`;

            const resultDiv = document.getElementById('test2-result');

            // Parse URL components
            const url = new URL(dataUrl);
            const pathParts = url.pathname.split('/').filter(p => p);

            const checks = {
                'Protocol is HTTPS': url.protocol === 'https:',
                'Host is correct': url.hostname === host,
                'Database name in path': pathParts[0] === db,
                'Command is "object"': pathParts[1] === 'object',
                'Table ID is correct': pathParts[2] === tableId,
                'Query contains JSON_DATA': url.search === '?JSON_DATA'
            };

            const allPassed = Object.values(checks).every(v => v);

            let checksHtml = '<ul style="margin: 10px 0; padding-left: 20px;">';
            for (const [check, passed] of Object.entries(checks)) {
                checksHtml += `<li>${passed ? '✓' : '✗'} ${check}</li>`;
            }
            checksHtml += '</ul>';

            resultDiv.className = 'test-case ' + (allPassed ? 'pass' : 'fail');
            resultDiv.innerHTML = `
                <strong>${allPassed ? '✓ PASS' : '✗ FAIL'}</strong>: URL Format Validation<br>
                <div class="result">
                    <strong>URL Components:</strong>
                    ${checksHtml}
                    <strong>Full URL:</strong> <span class="code">${dataUrl}</span>
                </div>
            `;

            return allPassed;
        }

        // Test Case 3: Metadata ID Usage
        function test3_metadataIdUsage() {
            const resultDiv = document.getElementById('test3-result');

            // Simulate old incorrect behavior (using type instead of id)
            const incorrectTableId = mockMetadata.type;
            const incorrectUrl = `https://${window.location.hostname}/${window.db}/object/${incorrectTableId}/?JSON_DATA`;

            // Correct behavior (using id)
            const correctTableId = mockMetadata.id;
            const correctUrl = `https://${window.location.hostname}/${window.db}/object/${correctTableId}/?JSON_DATA`;

            const isCorrect = correctTableId === mockMetadata.id && correctTableId !== mockMetadata.type;

            resultDiv.className = 'test-case ' + (isCorrect ? 'pass' : 'fail');
            resultDiv.innerHTML = `
                <strong>${isCorrect ? '✓ PASS' : '✗ FAIL'}</strong>: Metadata ID Usage<br>
                <div class="result">
                    <strong>Metadata ID:</strong> <span class="code">${mockMetadata.id}</span><br>
                    <strong>Metadata Type:</strong> <span class="code">${mockMetadata.type}</span><br>
                    <strong>Correct URL (using id):</strong> <span class="code">${correctUrl}</span><br>
                    <strong>Incorrect URL (using type):</strong> <span class="code" style="text-decoration: line-through; opacity: 0.6;">${incorrectUrl}</span><br>
                    <br>
                    <strong>Note:</strong> The URL must use <span class="code">metadata.id</span> (table ID: ${mockMetadata.id}),
                    not <span class="code">metadata.type</span> (column type: ${mockMetadata.type}).
                </div>
            `;

            return isCorrect;
        }

        // Run all tests
        function runAllTests() {
            console.log('Starting URL construction tests...');

            const results = {
                test1: test1_urlConstruction(),
                test2: test2_urlFormatValidation(),
                test3: test3_metadataIdUsage()
            };

            const allPassed = Object.values(results).every(v => v);

            console.log('Test Results:', results);
            console.log(allPassed ? 'All tests PASSED ✓' : 'Some tests FAILED ✗');

            // Add summary
            const summary = document.createElement('div');
            summary.className = 'test-section';
            summary.innerHTML = `
                <h2>Summary</h2>
                <div class="result">
                    <strong class="${allPassed ? 'success' : 'error'}">
                        ${allPassed ? '✓ All tests passed!' : '✗ Some tests failed'}
                    </strong>
                    <p>
                        Test 1 (URL Construction): ${results.test1 ? '✓ Pass' : '✗ Fail'}<br>
                        Test 2 (URL Format): ${results.test2 ? '✓ Pass' : '✗ Fail'}<br>
                        Test 3 (Metadata ID): ${results.test3 ? '✓ Pass' : '✗ Fail'}
                    </p>
                </div>
            `;
            document.body.appendChild(summary);
        }

        // Run tests when page loads
        window.addEventListener('DOMContentLoaded', runAllTests);
    </script>
</body>
</html>
