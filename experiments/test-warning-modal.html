<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Warning Modal - Issue #494</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }

        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }

        /* Modal styles matching integram-table.js */
        .integram-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .integram-modal {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
        }

        .integram-modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid #e5e5e5;
        }

        .integram-modal-header h5 {
            margin: 0;
            font-size: 18px;
        }

        .integram-modal-body {
            padding: 20px;
        }

        .integram-modal-footer {
            padding: 15px 20px;
            text-align: right;
            border-top: 1px solid #e5e5e5;
        }

        .alert {
            padding: 15px;
            border-radius: 4px;
        }

        .alert-warning {
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }

        .result-box {
            margin-top: 15px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>Test Warning Modal - Issue #494 / #496</h1>
    <p>Testing the warning modal functionality for record creation, with hyperlink support (Issue #496).</p>

    <div class="test-section">
        <h3>Test 1: Show Warning Modal (without link)</h3>
        <p>Click to simulate a server response with a warning message but no found record link.</p>
        <button onclick="testWarningModal()">Test Warning Modal</button>
    </div>

    <div class="test-section">
        <h3>Test 2: Simulate Save with Warning + Link to Found Record (Issue #496)</h3>
        <p>Click to simulate the save flow where server returns a warning AND an obj ID for the found record.</p>
        <button onclick="testSaveWithWarning()">Test Save with Warning + Link</button>
        <div id="result" class="result-box" style="display:none;"></div>
    </div>

    <div class="test-section">
        <h3>Test 3: Simulate Save Success (No Warning)</h3>
        <p>Click to simulate a successful save without warning.</p>
        <button onclick="testSaveSuccess()">Test Save Success</button>
    </div>

    <script>
        // Utility function from integram-table.js
        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            return String(text).replace(/&/g, '&amp;')
                              .replace(/</g, '&lt;')
                              .replace(/>/g, '&gt;')
                              .replace(/"/g, '&quot;')
                              .replace(/'/g, '&#039;');
        }

        // The showWarningModal function as implemented (updated with objId support)
        function showWarningModal(message, objId = null) {
            const modalId = `warning-modal-${ Date.now() }`;

            // Build link HTML if objId is provided
            let linkHtml = '';
            if (objId) {
                const editUrl = `/demo/edit_obj/${ objId }`;
                linkHtml = `
                    <a href="${ editUrl }" target="_blank" class="integram-modal-link" style="display: block; margin-top: 12px; color: #1976d2; text-decoration: none; font-weight: 500;">
                        Открыть найденную запись ↗
                    </a>
                `;
            }

            const modalHtml = `
                <div class="integram-modal-overlay" id="${ modalId }">
                    <div class="integram-modal" style="max-width: 500px;">
                        <div class="integram-modal-header">
                            <h5>Предупреждение</h5>
                        </div>
                        <div class="integram-modal-body">
                            <div class="alert alert-warning" style="margin: 0;">
                                ${ escapeHtml(message) }
                            </div>
                            ${ linkHtml }
                        </div>
                        <div class="integram-modal-footer" style="padding: 15px; text-align: right;">
                            <button type="button" class="btn btn-primary" data-close-warning-modal="true">OK</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            const overlay = document.getElementById(modalId);
            const closeBtn = overlay.querySelector('[data-close-warning-modal="true"]');

            closeBtn.addEventListener('click', () => {
                overlay.remove();
            });

            // Also close on click outside the modal
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.remove();
                }
            });
        }

        // Test 1: Direct modal test (without link)
        function testWarningModal() {
            showWarningModal('Клиент с таким номером телефона уже существует. Пожалуйста, проверьте данные.');
        }

        // Test 2: Simulate save with warning and link to existing record
        function testSaveWithWarning() {
            // Simulate server response with obj field (ID of found record)
            const mockResponse = {
                id: 123,
                warning: 'Внимание: запись создана, но обнаружены дубликаты. Пожалуйста, проверьте данные.',
                obj: 456 // ID of the existing/found record
            };

            document.getElementById('result').style.display = 'block';
            document.getElementById('result').textContent = 'Server response:\n' + JSON.stringify(mockResponse, null, 2);

            // Check for warning (this is the new logic with objId support)
            if (mockResponse.warning) {
                showWarningModal(mockResponse.warning, mockResponse.obj || null);
                console.log('Warning detected - form should stay open (not closed)');
                return; // This is the key - we return early, keeping the form open
            }

            // This code would only run if no warning
            console.log('No warning - would close form and refresh');
        }

        // Test 3: Simulate successful save
        function testSaveSuccess() {
            const mockResponse = {
                id: 456
            };

            // Check for warning (this is the new logic)
            if (mockResponse.warning) {
                showWarningModal(mockResponse.warning, mockResponse.obj || null);
                return;
            }

            alert('Success! Record saved. Form would close and table would refresh.');
        }
    </script>
</body>
</html>
