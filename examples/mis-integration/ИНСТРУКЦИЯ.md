# Инструкция по тестированию интеграции с МИС Инфоклиника

Скрипт `mis_integration.py` проверяет два метода API МИС:

| Метод | Описание |
|---|---|
| `CLIENTS_CHANGE_LIST` (п. 3.2.1) | Получение списка изменений в картотеке пациентов |
| `CLIENT_ADD` (п. 3.2.5) | Регистрация нового пациента |

Документация: https://docs.infoclinica.ru/icru/integration/crm-schedule

---

## 1. Что нужно получить от МИС

Перед запуском запросите у поставщика МИС (Инфоклиника) следующее:

| Что нужно | Описание |
|---|---|
| **SSL-сертификат клиента** | Файл `.crt` (или `.pem`) — ключ обмена, выдаётся МИС |
| **Приватный ключ** | Файл `.key` к сертификату |
| **Адрес вашего филиала** | Вида `demo.infoclinica.ru` — хост на портале Инфоклиника.RU |
| **Идентификатор филиала** | Числовой ID для заголовка `MSH.99` (можно запросить через `GET_FILIAL_LIST`) |

---

## 2. Настройка скрипта

Откройте файл `mis_integration.py` и измените переменные в разделе **КОНФИГУРАЦИЯ**:

```python
# ── Шаг 1: путь к файлу SSL-сертификата ─────────────────────────────────────
SSL_CERT_FILE = "client.crt"   # <-- вставьте имя вашего файла сертификата

# ── Шаг 2: путь к приватному ключу ──────────────────────────────────────────
SSL_KEY_FILE  = "client.key"   # <-- вставьте имя файла ключа

# ── Шаг 3: хост вашего медучреждения ────────────────────────────────────────
CLINIC_HOST   = "demo.infoclinica.ru"   # <-- замените на реальный хост

# ── Шаг 4: числовой идентификатор филиала ───────────────────────────────────
FILIAL_ID     = 1              # <-- замените на реальный идентификатор
```

Файлы сертификата и ключа положите в ту же папку, что и скрипт,
**или** укажите полный путь, например: `SSL_CERT_FILE = "/home/user/certs/client.crt"`.

> **Важно:** никогда не добавляйте файлы сертификатов в Git-репозиторий.

---

## 3. Требования к окружению

| Требование | Описание |
|---|---|
| Python | 3.10 и выше (используются только стандартные библиотеки) |
| Сетевой доступ | `api.infoclinica.ru` по порту 443 (HTTPS) |
| SSL | Файлы сертификата и ключа (п. 1) |

Установка дополнительных пакетов **не требуется**.

---

## 4. Запуск

### Показать справку

```bash
python mis_integration.py --help
```

### Тест CLIENTS_CHANGE_LIST — получить изменения по картотеке

```bash
python mis_integration.py --get-changes
```

С явным указанием ID филиала:

```bash
python mis_integration.py --get-changes --filial 42
```

Скрипт выведет в консоль:

```
============================================================
ЗАПРОС: CLIENTS_CHANGE_LIST
Филиал: 42, Хост: demo.infoclinica.ru
============================================================
SPRESULT : 1
SPCOMMENT: Список изменений получен

Получено изменений: 3

  [1] CHANGEID=1001 OP=0 PCODE=50001
       Иванов Пётр Сергеевич / +7(916)123-45-67
  ...
```

| CHANGEOP | Значение |
|---|---|
| 0 | Добавление |
| 1 | Изменение |
| 2 | Удаление |

> **Важно:** метод возвращает пакет до 100 записей.
> Если получено ровно 100 — повторите запрос до получения пакета менее 100 записей.

---

### Тест CLIENT_ADD — зарегистрировать пациента

По умолчанию скрипт использует тестового пациента из переменной `TEST_PATIENT`:

```bash
python mis_integration.py --add-patient
```

Вывод при успехе:

```
============================================================
ЗАПРОС: CLIENT_ADD
Пациент: Тестов Тест Тестович
============================================================
SPRESULT : 1
SPCOMMENT: Пациент добавлен
PCODE    : 99999  (идентификатор нового пациента в МИС)
```

Добавить конкретного пациента через аргумент командной строки:

```bash
python mis_integration.py --add-patient \
  --patient '{"LASTNAME":"Иванов","FIRSTNAME":"Иван","MIDNAME":"Петрович","BDATE":"19850315","PHONE":"+7(916)123-45-67"}'
```

Поля для `--patient`:

| Поле | Обязателен | Описание |
|---|---|---|
| `LASTNAME` | ✅ | Фамилия |
| `FIRSTNAME` | ✅ | Имя |
| `BDATE` | ✅ | Дата рождения в формате `YYYYMMDD` |
| `MIDNAME` | | Отчество |
| `EMAIL` | | Email |
| `PHONE` | | Телефон в формате `+7(000)000-00-00` |
| `GENDER` | | 1 — Мужской, 2 — Женский |
| `SNILS` | | СНИЛС |
| `CHECKMODE` | | 1 — ФИО+дата рождения (по умолчанию) |

Коды ответа SPRESULT:

| Код | Описание |
|---|---|
| 1 | Пациент добавлен |
| -1 | Не заполнен обязательный параметр |
| -2 | Пациент с такими реквизитами уже существует |
| -3 | Ошибка при добавлении пациента |
| -5 | Добавление пациентов с такими реквизитами запрещено |

---

### Запуск обоих тестов сразу

```bash
python mis_integration.py --all
```

---

## 5. Частые ошибки

| Ошибка | Причина | Решение |
|---|---|---|
| `[Errno 2] No such file or directory: 'client.crt'` | Не указан путь к сертификату | Проверьте `SSL_CERT_FILE` и `SSL_KEY_FILE` в скрипте |
| `HTTP 401` или `403` | Неверный сертификат | Убедитесь, что сертификат выдан именно для вашей внешней системы |
| `SPRESULT: 0`, комментарий «Вызов заблокирован» | МИС ещё не подтвердила изменения или не дала прав | Проверьте настройки разрешений в МИС |
| `SPRESULT: -2` (CLIENT_ADD) | Пациент уже существует | Измените тестовые данные (`TEST_PATIENT`) |
| Таймаут / нет подключения | Нет доступа к `api.infoclinica.ru:443` | Проверьте сетевые настройки и файрвол |

---

## 6. Как получить список филиалов

Если идентификатор филиала неизвестен, его можно запросить методом `GET_FILIAL_LIST`
(не описан в данном скрипте, вызывается на ЦБД **без** заголовка `X-Forwarded-Host`):

```
Запрос: GET_FILIAL_LIST
Параметры: FILLIST = -1, VIEWINWEB = -1
```

Подробнее: п. 2.2.3 документации Инфоклиника.

---

## 7. Следующие шаги после успешного теста

1. Реализовать **цикл подтверждения** изменений (`CLIENTS_CHANGE_ACCEPT`, п. 3.2.2)
   — без подтверждения МИС будет возвращать одни и те же изменения снова.

2. Обработать пагинацию: если `len(changes) == 100`, запросить следующий пакет.

3. Добавить **синхронизацию** полученных пациентов с CRM (сопоставление по PCODE).

4. Реализовать запись на приём (`WEB_SCHEDULE_CHANGE_LIST`, п. 3.3) при необходимости.
